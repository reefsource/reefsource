machine:
  services:
    - docker

  python:
    version: 3.5.2

  node:
    version: 6.10.0

  environment:
    DJANGO_SETTINGS_MODULE: reefsource.settings.test

dependencies:
  override:
    - pip install -r requirements/circleci.txt
#    - npm install

compile:
  override:
    - ./bin/set-version.sh

test:
  override:
    - coverage run manage.py test --noinput

deployment:
  master:
    branch: master
    owner: reefsource
    commands:
      - aws --version
      - aws configure set default.region us-east-1
      - aws configure set default.output json
      - $(aws ecr get-login)
      - docker info
      - docker build --tag 078097297037.dkr.ecr.us-east-1.amazonaws.com/reefsource:latest --tag 078097297037.dkr.ecr.us-east-1.amazonaws.com/reefsource:$CIRCLE_BUILD_NUM .
      - docker push 078097297037.dkr.ecr.us-east-1.amazonaws.com/reefsource:$CIRCLE_BUILD_NUM
      - docker push 078097297037.dkr.ecr.us-east-1.amazonaws.com/reefsource:latest
      - ./bin/package-static.sh
